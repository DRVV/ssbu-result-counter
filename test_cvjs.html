<html>

<head>



</head>

<body>
    <table>
        <tr>
            <td>
                <p style="text-align:center">WebRTC capturing OBS virtual camera</p>
                <video id="videoInput" width="400" height="300"></video>
            </td>
            <td>
                <p style="text-align:center">opencv.js processing the stream realtime</p>
        <canvas id="canvasOutput" width="400" height="300"></canvas>
            </td>
        </tr>
        <tr>
            <p id="errorMessage">message here</p>
        </tr>
    </table>
    <div>
        
        
    </div>
    
    <div>
        
    </div>
</body>
<script src="https://docs.opencv.org/4.5.5/utils.js" type="text/javascript"></script>
<script>
    let utils = new Utils('errorMessage');
    
    // utils.loadCode('codeSnippet', 'codeEditor');

    let video = document.getElementById("videoInput"); // video is the id of video tag
    let streaming = false;
    let src = false;
    let dst = false;
    let cap = false;
    navigator.mediaDevices.getUserMedia({ video: true, audio: false })
        .then(function (stream) {
            video.srcObject = stream;
            video.play();
            console.log("video started")

            streaming = video.srcObject;

        })
        .catch(function (err) {
            console.log("An error occurred! " + err);
        });

    function openCvReady() {
        cv['onRuntimeInitialized'] = () => {
            src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
            dst = new cv.Mat(video.height, video.width, cv.CV_8UC4);
            cap = new cv.VideoCapture(video);
            setTimeout(processVideo, 0)
        };
    }
    // let video = document.getElementById("videoInput");
    // let streaming = video.srcObject;
    // let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
    // let dst = new cv.Mat(video.height, video.width, cv.CV_8UC4);
    // // let gray = new cv.Mat();
    

    function processVideo() {
        
        // let faces = new cv.RectVector();
        // let classifier = new cv.CascadeClassifier();

        // load pre-trained classifiers
        //classifier.load('haarcascade_frontalface_default.xml');
        const FPS = 30;
        try {
            //console.log("inside Try")
            
            let begin = Date.now();
            //console.log(begin);
            // start processing.
            cap.read(src);
            src.copyTo(dst);
            cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);

            cv.imshow('canvasOutput', dst);
            // schedule the next one.
            let delay = 1000 / FPS - (Date.now() - begin);
            setTimeout(processVideo, delay);
            //console.log("final statement")

        } catch (err) {
            //console.log(err)
            // setTimeout(processVideo, 1)
            //processVideo()
            utils.printError(err);
        }
    };

    // function onOpenCvReady() {

    //     console.log("READY!")
    //     // schedule the first one.
    //     setTimeout(processVideo, 0);
    // }


</script>
<!-- <script type="text/javascript">
    // let utils = new Utils('errorMessage');
    
    // utils.loadCode('codeSnippet', 'codeEditor');
    
    let streaming = false;
    let videoInput = document.getElementById('videoInput');
    let startAndStop = document.getElementById('startAndStop');
    let canvasOutput = document.getElementById('canvasOutput');
    let canvasContext = canvasOutput.getContext('2d');
    
    startAndStop.addEventListener('click', () => {
        if (!streaming) {
            utils.clearError();
            utils.startCamera('qvga', onVideoStarted, 'videoInput');
        } else {
            utils.stopCamera();
            onVideoStopped();
        }
    });
    
    function onVideoStarted() {
        streaming = true;
        startAndStop.innerText = 'Stop';
        videoInput.width = videoInput.videoWidth;
        videoInput.height = videoInput.videoHeight;
        utils.executeCode('codeEditor');
    }
    
    function onVideoStopped() {
        streaming = false;
        canvasContext.clearRect(0, 0, canvasOutput.width, canvasOutput.height);
        startAndStop.innerText = 'Start';
    }
    
    utils.loadOpenCv(() => {
        startAndStop.removeAttribute('disabled');
    });
    </script> -->
<script src="https://docs.opencv.org/4.5.5/opencv.js" type="text/javascript" onload="openCvReady()">    </script>


</script>




</html>